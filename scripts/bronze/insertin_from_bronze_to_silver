-- Query for data transform and cleancing 
--1. find out there is 3 rows with cst_id = 29466 with different time the approach is to rank them with cst_create_date
--1.2 Doing with row_number rather than rank() because rank() goes for all customers but we are fucasig on one customer
--1. standardization for gender and marital status 2.trim first and last anme 3.Dealing with doplicate and null in cst_id primary key

insert into silver.crm_cust_info(
cst_id ,cst_key ,cst_firstname ,cst_lastname ,cst_marital_status ,cst_gndr ,cst_create_date)
select
cst_id
,cst_key
,trim(cst_firstname) as cst_firstname
,trim(cst_lastname) as cst_lastname
,case	upper(trim(cst_marital_status))
	when  'M' then 'Married'
	when 'S' then 'Single'
	else 'Unknown'
 end as cst_marital_status 
,case upper(trim(cst_gndr))
	when 'F' then 'Female'
	when 'M' then 'Male'
	else 'Unknown'
end as cst_gndr
,cst_create_date
from( select
	*,
	ROW_NUMBER() over (partition by cst_id order by cst_create_date desc) as flag_last 
	from bronze.crm_cust_info
	where cst_id is not null)tmp
where flag_last = 1 ;
